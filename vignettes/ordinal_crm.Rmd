---
title: "The Ordinal CRM"
bibliography: vignettes.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The Ordinal CRM}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(dplyr)
library(ggplot2)
library(kableExtra)
library(knitr)
library(magrittr)
library(tibble)
library(tidyr)

devtools::load_all()
```

## The Ordinal CRM
The ordinal CRM, or oCRM, is an extension to the standard CRM in which the patient's response is not binary (no DLT, DLT) but ordinal (for example: None, sub-DLT, DLT).  The number of categories in the response scale is arbitrary.  The responses are modeled using a standard parameterisation for ordered logistic regression:

Let p~k~(x_d) be the probability that the response of a patient treated at dose x~d~ is in category k *_or higher_*, k=0, ..., K; d=1, ..., D.

Then 
$$ 
log\left(\frac{p_k(x_d)}{1 - p_k(x_d)}\right) = \alpha_k + \beta \times log(x_d/x_{ref}), k=1, ..., K. 
$$
[p~0~(d) = 1 by definition.]

where x~ref~ is a reference dose.  The &alpha;s are constrained such that &alpha;~1~ > &alpha;~2~ > ... > &alpha;~K~.

The model is a constrained parallel lines regression on the logit scale with appropriate priors imposed on the &alpha;~k~s and &beta;.

Note that the constraints on the \alpha~k~s induces a correlation between the model parameters that is difficult to quantify in advance and which will change over time as the model evolves as responses are observed.  For this reason, `crmPack` does not allow the specification of priors for this model that involve  non-zero correlations between the model's parameters.  They must be independent.  The priors for the model parameters are

$$ \alpha_1 \sim N(\mu_1, \sigma_1^2), $$
$$ \alpha_i \sim N(\mu_i, \sigma_i^2)  T( , \alpha_{i-1}) $$ for i = 2, ..., k and

$$ log(\beta) \sim N(\mu_{beta}, \sigma_{beta}^2) $$
where T(L, U) denotes truncation of the underlying distribution between limits L and U, with missing arguments being interpreted as infinite.

## Implementation

### Ordinal data
`DataOrdinal` is the class `crmPack` uses to store data observed in an ordinal CRM trial.  It is identical to the existing `Data` class, save for the addition of the `yCategories` slot, which defines both the number of toxicity categories, and their labels (though some methods allow these labels to be overridden).

```{r}
trial_data0 <- DataOrdinal(
  doseGrid = seq(10, 100, 10),
  yCategories = c("No tox" = 0L, "Sub tox AE" = 1L, "DLT" = 2L)
)
```

If `yCategories` is omitted from the call to `DataOrdinal`, a default value of `c("No DLT" = 0L, "DLT" = 1L)` is used, which makes `Dataordinal` object equivalent to a standard `Data` object, save for a slight difference in the labeling of the toxicity categories.

As with `Data` objects, the `update` method can be used to add observed data to a `DataOrdinal` object, or the `x` and `y` arguments to the constructor can provide observed data on creation.

```{r}
trial_data0 <- update(trial_data0, x = 50, y = 0L)

trial_data1 <- DataOrdinal(
  doseGrid = seq(10, 100, 10),
  x = 50,
  y = 0L,
  yCategories = c("No tox" = 0L, "Sub tox AE" = 1L, "DLT" = 2L)
)

identical(trial_data0, trial_data1)
```

The `plot` provides a visual representation of the `DataOrdinal` object.

```{r, fig.width = 6}
trial_data <- DataOrdinal(
  x = c(25, 25, 25, 25, 50, 50, 50, 50, 100, 100, 100, 100),
  y = c(0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 0L, 1L, 2L),
  doseGrid = seq(25, 300, 25),
  placebo = FALSE,
  ID = 1:12,
  cohort = c(1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 3L, 3L, 3L, 3L),
  yCategories = c("No tox" = 0L, "Sub-tox AE" = 1L, "DLT" = 2L)
)

plot(trial_data, legend = TRUE)
```

The `plot` method has parameters `tox_labels` and `tox_shapes` to allow customisation of its output.  The method attempts to choose sensible shapes when the there are fewer than ten toxicity categories and sensible colours when there are fewer than six.

> Clearly, the existing `Data` class could be considered a special case of `DataOrdinal` with two toxicity categories and fixed labels.  Thus, there is a strong case from the purist point of view for making `Data` a sub-class of the `DataOrdinal` sub-class.  However, we took a defensive and pragmatic decision when introducing the `DataOrdinal` class to make it a sibling of `Data`, making both direct descendants of `GeneralData`.  We did this both to reduce the amount of work to make the change and to minimise the risk of unexpected consequences for end users of `crmPack`, there being many instances in the existing code base of an implicit assumption that there are only two possible toxicity categories.

### The ordinal CRM model
The `OrdinalLogisticLogNormal` class implements models of this type in `crmPack`.  `OrdinalLogisticLogNormal` is a sub-class of `ModelLogNormal`.  The constructor has arguments `mean`, `cov` and `ref_dose`, which all have the obvious meanings.  For consistency with other sub-classes of `ModelLogNormal`, `cov` should be a (diagonal) matrix rather than a vector.  Elements of both `mean` and `cov` define the parameters of the priors for the model parameters &alpha;~1~, &alpha;~2~, ..., &alpha;~k~ and log(&beta;), in that order.  Because p~0~ is fixed by definition, there is no &alpha;~0~ in the model.

### `mcmc`

The `mcmc` method works without change:

```{r}
mcmc_options <- McmcOptions(burnin = 500, samples = 1000)

model <- LogisticLogNormalOrdinal(
  mean = c(-3, -4, 0),
  cov = diag(c(3, 4, 1)),
  ref_dose = 50
)

empty_data <- DataOrdinal(doseGrid = seq(10, 100, 10))
prior_samples <- mcmc(empty_data, model, mcmc_options)
```

and

```{r}
trial_samples <- mcmc(trial_data, model, mcmc_options)
```



### `doseFunction`

To do.

### `probFunction`

To do.

### `dose`

To do.

### `prob`

To do.

### `Samples-fit`

To do.

### `Samples-approximate`

To do.

### `Samples-plot`

To do.

## Proposal: Interaction with other `crmPack` classes
`DataOrdinal` and `LogisiticLogNormalOrdinal` objects need to interact with other `crmPack` classes such as `CohortSize`, `increments` and `NextBest` many of which make an implicit assumption that toxicity is dichotomous.  With ordinal data, this is not the case.  One could create ordinal variants of every such class.  This is a significant amount of work.  Pragmatically, I suggest a simple solution...

For each `crmPack` super class (such as `CohortSize` and `Stopping`), define a wrapper ordinal-specific class with three slots: `grade`, `cumulative` and `rule`, where `rule` is one of the existing concrete classes.  The wrapper class would extract the relevant `grade`-specific probabilities of toxicity from the supplied `Samples` object, create a pseudo `Samples` object of the equivalent binary probabilities and pass this pseudo object to the rule.  `cumulative` would be a `flag` indicating whether or not the probabilities used would refer to the given `grade` alone or all `grade`s equal to or greater than the given `grade`.  This allows all existing rules to be applied to the results of an ordinal CRM trial with minimal effort.

For example
```{r, eval = FALSE}
NextBestOrdinal(
  grade = 2,
  NextBestNCRM(target = c(0.2, 0.35), overdose = c(0.35, 1), max_over_dose_prob = 0.25),
  cumulative = FALSE
)
```

would apply a `NextBestNCRM` rule to the posterior probabilities of grade 2 toxicity.

## Consequential changes to existing classes and methods

*  `h_plot_data_df` is now generic.  It's behaviour for existing `Data` classes is unchanged.
*  `ModelParams` now supports models with more than two parameters.



## Final observation
The simulations used in this vignette have used relatively short chains of 1000 samples, purely in the interests of speed.  When investigating the properties of a real trial, much longer chain lengths should be used.  For example, to estimate a binomial probability to an accuracy of &plusmn;1%, an effective sample size (ESS) of around 40,000 is required.

## References
