---
title: "Using tidy methods"
author: "John Kirkpatrick"
date: "10/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
devtools::load_all()
```

## Introduction
Here is a first draft implementation of borrom-like methods for `crmPack, as suggested in [issue 323](https://github.com/Roche/crmPack/issues/323).

### Principles
The principles I have used in tidying `crmPack` objects are as follows:

* All slots that are not functions are converted to tibbles or a list of tibbles.
* If the slot is scalar, the slot is converted to a 1x1 tibble.  This will ease downstream operations such as `row-bind`ing.
* If the object being tidied contains multiple slots of (potentially) different lengths, the results is a list of tibbles.  The list may be nested to multiple levels.  (See, for example, `ModelParamsNormal`.)
* The column names of the tidied tibble correspond to the slot names of the parent object.
* If an object contains a vector or matrix of values that correspond to an "obvious" set of parameters, columns take on the names of those parameters and the tibble is augmented by a column named `Parameter`.  This most often happens in the mean vector and covariance matrix of `ModelParamsNormal`.
* When the value of a slot has not been set, a zero-row tibble is returned.
* `tbl_<className>` is prepended to the class of the tidy tibble.

### Exceptions
*  Where a vector slot (or series of vector slots) define a range, then the naming convention described above is not followed.  Instead, columns named `min` and `max` define the extent of the range and a column named `Range` labels the range.  Not all instances of this paradigm have been implemented.

### Simple examples

`CohortSizeConst` is a trivial example.

```{r}
x <- CohortSizeConst(size=3) %>% tidy()
x
class(x)

```

`NextBestNCRM` demonstrates how ranges are represented.
```{r}
x <- NextBestNCRM(
      target = c(0.2, 0.35),
      overdose = c(0.35, 1),
      max_overdose_prob = 0.25
    ) %>% tidy()
x
class(x)
```

Various subclasses of `GeneralModel` demonstrate how `tidy()` handles both slots of different classes and nesting.  Here is `LogisticLogNormal` as an example.

```{r}
LogisticLogNormal(
  mean = c(-0.85, 1),
  cov = matrix(c(1, -0.5, -0.5, 1), nrow = 2),
  ref_dose = 50
) %>%  tidy()
```

### To do
* Implement `min`/`max` paradigm for all ranges.
* Implement `glimpse` and `augment` methods.  I see this as a relatively low priority task.
* Further test - and most likely improve - the handing of classes that support nesting, such as `StoppingAll` and `StoppingAny` when more than two levels of nesting are used.
* Update README once these changes are merged with main.

## Comprehensive listing of all tidy methods
